<html>
	<head>
	<script src="js/jquery.js"></script>
	<script type="text/javascript" src="js/char_movement.js"></script>
	<script type="text/javascript" src="js/background_movement.js"></script>
	<script>
			var active_mob_positions = [];
			var last_id = 0;
			var mob_move_directions = ["up", "down", "left", "right"];
			var mobs_running = [];
			var active_mobs = {};
			var currently_moving_mob = 0;
			var mob_is_moving = false;
			var drawings = ["up0","up1","up2","down0","down1","down2","left0","left1","left2","right0","right1","right2"];
			var mob_images = {};
			var x_offset = 10;
			var y_offset = 10;
			var mob_move_intervals = {};
			
			function move_that_mob(mob_id, mob_field, target_field, mob_img_parts, move_direction, animation_phases)
			{
				//debugger;
				/*if ( mob_is_moving == true )
				{
					setTimeout(move_that_mob, 500, mob_field, move_direction);
				}*/
				//var mob_pos_key = active_mobs[currently_moving_mob];
				mob_face_direction = active_mobs[mob_id][2];
				var mob_move_counter = active_mobs[mob_id][1];
				var mob_img_file = mob_img_parts[0]+"_"+move_direction+"_"+mob_img_parts[1];
				/*if ( mob_face_direction != move_direction )
				{
					var turned_mob = new Image();
					turned_mob.onload = function() {
						canvas = document.getElementById("canvas");
						c = canvas.getContext("2d");
						c.clearRect(current_mob_x, current_mob_y, char_width, char_height);
						c.drawImage(turned_mob, current_mob_x, current_mob_y, char_width, char_height);
						
					};
					turned_mob.src = mob_img_file;
					active_mobs[mob_id][2] = move_direction;
					clearInterval(interval);
					active_mobs[mob_id][1] = 0;
					running = false;
					move_lock = false;
					return;
					//var turned_mob = get_image(mob_img_file);
					
				}*/
				var standing = new Image();
				standing.src = mob_img_parts[0]+"_"+move_direction+"_"+mob_img_parts[1]+".png";
				canvas = document.getElementById("canvas");
				c = canvas.getContext("2d");
				
				var current_mob_x = active_mobs[mob_id][3];
				var current_mob_y = active_mobs[mob_id][4];
				var old_x = current_mob_x;
				var old_y = current_mob_y;
				if ( move_direction == "down" )
				{
					current_mob_y = current_mob_y + 8;
				}
				else if ( move_direction == "up" )
				{
					current_mob_y = current_mob_y - 8;
				}
				else if ( move_direction == "left" )
				{
					current_mob_x = current_mob_x - 5;
				}
				else if ( move_direction == "right" )
				{
					current_mob_x = current_mob_x + 5;
				}
				active_mobs[mob_id][3] = current_mob_x;
				active_mobs[mob_id][4] = current_mob_y;
				var image = get_animation_image(mob_img_file, move_direction, animation_phases, mob_move_counter);
				c.clearRect(old_x, old_y, char_width, char_height);
				for ( var tries = 0; tries < 3; tries++ )
				{
					try
					{
						c.drawImage(image, current_mob_x ,current_mob_y, char_width, char_height);
						break;
					}
					catch (exception)
					{
						image = get_animation_image(mob_img_file, move_direction, animation_phases, mob_move_counter);
					}
				}
				mob_move_counter = mob_move_counter + 1;
				//console.log("debug: "+move_counter);
				if ( mob_move_counter >= animation_parts )
				{
					c.clearRect(old_x, old_y, char_width, char_height);
					c.drawImage(standing, current_mob_x ,current_mob_y, char_width, char_height);
					clearInterval(mob_interval);
					active_mobs[mob_id][1] = 0;
				}
				active_mobs[mob_id][1] = mob_move_counter;
			}

			function move_mob_new(id, current_field, target_field, move_direction)
			{
				//debugger;
				var mob = mob_images[id]["div"];
				var standing_mob = mob_images[id][move_direction+"0"];
				var mob_face_direction = active_mobs[id][2];
				if ( mob_face_direction != move_direction )
				{
					active_mobs[id][2] = move_direction;
					change_mob_objects_view(id, standing_mob);
					return;
				}
				var target_x = grid_from_above[target_field][0];
				var target_y = grid_from_above[target_field][1];
				mob_move_intervals[id] = setInterval( function() {move_mob_div(id, move_direction, target_field, 5, target_x, target_y)}, 60 )
			}

			function move_mob_div(id, move_direction, target_field, pixels, target_x, target_y)
			{
				//debugger;
				var mob_div = mob_images[id]["div"];
				target_x += 10;
				target_y += 10;
				var current_x = parseInt(mob_div.style.left.replace("/px$/", ""));
				var current_y = parseInt(mob_div.style.top.replace("/px$/", ""));
				//current_x = current_x-x_offset;
				//current_y = current_y-y_offset; 
				console.log(current_x);
				var movement_counter = active_mobs[id][1];
				if ( move_direction == "left" )
				{
					current_x -= pixels;
				}
				else if ( move_direction == "right" )
				{
					current_x += pixels;
				}
				else if ( move_direction == "up" )
				{
					current_y -= pixels;
				}
				else if ( move_direction == "down" )
				{
					current_y += pixels;
				}
				mob_div.style.left = current_x;
				mob_div.style.top = current_y;
				if ( current_x == target_x && current_y == target_y )
				{
					move_interval = mob_move_intervals[id];
					//active_mobs[id][1] = 0;
					clearInterval(move_interval);
					active_mobs[id][0] = target_field;
					return;
				}
				active_mobs[id][1] = movement_counter+1;
			}

			function change_mob_objects_view(id, new_object)
			{
				var mob_objects = mob_images[id];
				for ( var key in mob_objects )
				{
					if ( key == "div" )
					{
						continue;
					}
					var current_obj = mob_objects[key];
					if ( current_obj == new_object )
					{
						current_obj.style.display = "";
					}
					else
					{
						current_obj.style.display = "none";
					}
				}
			}
			
			function move_mob(id, img_parts, position_key)
			{
				//debugger;
				var move_indicator = Math.floor((Math.random() * 2) + 1);
				if ( move_indicator == 2 )
				{
					var mob_log = document.getElementById("mob_log");
					var mob_log_content = mob_log.innerHTML;
					
					var direction_index = Math.floor((Math.random() * 3) + 0);
					var direction_to_move = mob_move_directions[direction_index];
					var animation_phases = 5;
					if ( direction_to_move == "left" || direction_to_move == "right" )
					{
						animation_phases = 8;
					}
					var current_mob_x = grid_from_above[position_key][0];
					var current_mob_y = grid_from_above[position_key][1];
					var mob_img_file = img_parts[0]+"_"+direction_to_move+"_"+img_parts[1]+".png";
					var new_position_key = get_target_field(position_key, direction_to_move);
					//var mob_face_direction = active_mobs[id][2];
					
					var current_datetime = new Date();
					/*if ( addition != undefined )
					{
						//console.log("mob("+id+"): moving around..."+addition);
						mob_log.innerHTML = mob_log_content+"<br>"+current_datetime.getHours()+":"+current_datetime.getMinutes()+" mob("+id+"): moving around..."
					}*/
						//console.log("mob("+id+"): moving around...");
					mob_log.innerHTML = mob_log_content+"<br>"+current_datetime.getHours()+":"+current_datetime.getMinutes()+" mob("+id+"): moving "+direction_to_move+"..."
					mob_interval = setInterval( function() { move_that_mob(id, position_key, new_position_key, img_parts, direction_to_move, animation_phases); }, 60);
				}
				mobs_running.push(setTimeout(move_mob, 5000, id, img_parts, position_key));
			}
			
			function init_mob()
			{
				if ( active_mob_positions.length >= 5 )
				{
					console.log("Es sind bereits 5 Mobs aktiv, mach die erstmal weg!");
					return;
				}
				var current_player_field = current_field_from_above;
				var p_row = parseInt(current_player_field.split(",")[0]);
				var p_col = parseInt(current_player_field.split(",")[1]);
				var min_row = p_row-1;
				var min_col = p_col-1;
				var max_row = p_row+1;
				var max_col = p_col+1;
				//var player_safe_zone = [(p_row-1)+","+(p_col-1), (p_row-1)+","+p_col, (p_row-1)+","+(p_col+1),  p_row+","+(p_col-1), p_row+","+p_col, p_row+","+(p_col+1), (p_row+1)+","+(p_col-1), (p_row+1)+","+p_col, (p_row+1)+","+(p_col+1)];
				var player_safe_zone = [];
				for ( var current_row = min_row; current_row <= max_row; current_row++ )
				{
					for ( var current_col = min_col; current_col <= max_col; current_col++ )
					{
						player_safe_zone.push(current_row+","+current_col);
					}
				}
				var mob_spawn_key = undefined;
				while ( true )
				{
					var new_key = generate_random_position_key()
					console.log(new_key);
					if ( $.inArray(new_key, player_safe_zone) != -1 )
					{
						continue;
					}
					if ( $.inArray(new_key, active_mob_positions) != -1 )
					{
						continue;
					}
					mob_spawn_key = new_key;
					break;
				}
				spawn_mob(mob_spawn_key);
			}
			
			function spawn_mob(position_key)
			{
				var canvas = document.getElementById("canvas");
				var c = canvas.getContext("2d");
				var mob_img_parts = ["images/dummy_sprite", "bandana"]
				var mob_img = get_image(mob_img_parts[0]+"_down_"+mob_img_parts[1]);
				var mob_x = grid_from_above[position_key][0];
				var mob_y = grid_from_above[position_key][1];
				active_mob_positions.push(position_key);
				active_mobs[last_id] = [position_key, 0, "down", mob_x, mob_y];
				var mob_drawing_object = document.createElement("div");
				//mob_drawing_object.id = "mob_"+last_id;
				mob_drawing_object.style.position = "absolute";
				mob_drawing_object.style.top = (mob_y+y_offset);
				mob_drawing_object.style.left = (mob_x+x_offset);
				mob_images[last_id] = {"div":mob_drawing_object};
				for ( var ccount = 0; ccount < 12; ccount++ )
				{
					var mob_canvas = document.createElement("canvas");
					mob_images[last_id][drawings[ccount]] = mob_canvas;
					//mob_canvas.id = "mob_move_"+drawings[ccount];
					//mob_canvas.style = "position:absolute;";
					mob_canvas.width = 40;
					mob_canvas.height = 40;
					if ( drawings[ccount] != "down0" )
					{
						mob_canvas.style.display = "none";
					}
					
					//mob_canvas.style.display = "none";
					mob_drawing_object.appendChild(mob_canvas);
				}
				document.body.appendChild(mob_drawing_object);
				c.drawImage(mob_img, mob_x, mob_y, char_width, char_height);
				//mobs_running.push(setTimeout(move_mob, 5000, last_id, mob_img_parts, position_key));
				draw_mob_images(last_id);
				last_id = last_id+1;
			}
			
			function draw_mob_images(id)
			{
				for ( var count = 0; count < 12; count++ )
				{
					var mob_canvas = mob_images[id][drawings[count]];
					var c_img = new Image();
					c_img.canvas = mob_canvas;
					c_img.onload = function() {
						var mob_canvas = this.canvas;
						var cc = mob_canvas.getContext("2d");
						cc.drawImage(this,0,0,40,40);
					};
					c_img.src = "images/dummy_sprite_"+drawings[count]+"_bandana.png";
				}
			}

			function move_mob_test()
			{
				var direction_index = Math.floor((Math.random() * 4) + 1);
				direction_index = direction_index-1;
				console.log(direction_index)
				var direction_to_move = mob_move_directions[direction_index];
				console.log(direction_to_move)
				var animation_phases = 5;
				/*if ( direction_to_move == "left" || direction_to_move == "right" )
				{
					animation_phases = 8;
				}
				var current_mob_x = grid_from_above[position_key][0];
				var current_mob_y = grid_from_above[position_key][1];
				var mob_img_file = img_parts[0]+"_"+direction_to_move+"_"+img_parts[1]+".png";
				var new_position_key = get_target_field(position_key, direction_to_move);
				//var mob_face_direction = active_mobs[id][2];
				
				var current_datetime = new Date();
				/*if ( addition != undefined )
				{
					//console.log("mob("+id+"): moving around..."+addition);
					mob_log.innerHTML = mob_log_content+"<br>"+current_datetime.getHours()+":"+current_datetime.getMinutes()+" mob("+id+"): moving around..."
				}* /
					//console.log("mob("+id+"): moving around...");
				mob_log.innerHTML = mob_log_content+"<br>"+current_datetime.getHours()+":"+current_datetime.getMinutes()+" mob("+id+"): moving "+direction_to_move+"..."
				mob_interval = setInterval( function() { move_that_mob(id, position_key, new_position_key, img_parts, direction_to_move, animation_phases); }, 60);
				*/
				var current_field = active_mobs[0][0];
				var new_position_key = get_target_field(current_field, direction_to_move);
				move_mob_new(0, current_field, new_position_key, direction_to_move);
			}
			
			function stop_all_running_mobs()
			{
				for ( var index = 0; index < mobs_running.length; index++ )
				{
					clearTimeout(mobs_running[index]);
				}
				var canvas = document.getElementById("canvas");
				var c = canvas.getContext("2d");
				for ( var posindex = 0; posindex < active_mob_positions.length; posindex++ )
				{
					var key = active_mob_positions[posindex];
					var mob_x = grid_from_above[key][0];
					var mob_y = grid_from_above[key][1];
					c.clearRect(mob_x, mob_y, char_width, char_height);
				}
				for ( var id = 0; id < last_id; id++ )
				{
					var element = document.getElementById("mob_"+id);
					element.remove();
				}
				active_mobs = {};
				active_mob_positions = [];
				last_id = 0;
			}
			
			function generate_random_position_key()
			{
				var random_row = Math.floor((Math.random() * 9) + 1);
				var random_col = Math.floor((Math.random() * 9) + 1);
				var random_key = random_row+","+random_col;
				return random_key;
			}
			
			function handle_key_event(evt)
			{
				//check_char_position()
				switch(evt.keyCode)
				{
					case 37:
						evt.preventDefault();
						animation_parts = 8;
						move_player("left");
						//start_moving("left");
						break;
					case 39:
						evt.preventDefault();
						animation_parts = 8;
						move_player("right");
						//start_moving("right");
						break;
					case 40:
						evt.preventDefault();
						animation_parts = 5;
						move_player("down");
						//start_moving("down");
						break;
					case 38:
						evt.preventDefault();
						animation_parts = 5;
						move_player("up");
						//start_moving("up");
						break;
				}
			}
			window.addEventListener('keydown', handle_key_event, true);
			
			function init()
			{
				init_grid();
				fill_grid_randomly();
				init_player();
			}
	</script>
	</head>
	<body onload="javascript:init()">
		<!-- <div style="position: relative;">
			
		</div> --> 
		<canvas id="background_canvas" width="480" height="400" style="position: absolute; left: 10; top: 10;"></canvas>
		<!-- <canvas id="canvas" width="480" height="400" style="position: absolute; left: 10; top: 10; z-index: 1;"></canvas> -->
		<button onclick="javascript:init_mob()" style="position: absolute; left: 0; top: 500;">spawn mob</button>
		<button onclick="javascript:move_mob_test()" style="position: absolute; left: 150; top: 500;">move</button>
		<button onclick="javascript:stop_all_running_mobs()" style="position: absolute; left: 300; top: 500;">kill all mobs</button>
		<div id="mob_log" style="position:absolute; left: 500; top: 0; width:500px; height:700px; overflow:auto;">Mob-Lob:
		</div>
	</body>
</html>