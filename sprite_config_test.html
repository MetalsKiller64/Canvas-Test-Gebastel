<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Spritekonfigurations-Test</title>
		<style>
			.grid_setup {
				float: left;
/* 				display: inline-block; */
			}
			.sprite_map_border {
				position: relative;
				display: inline-block;
				padding: 60px;
				background-color: grey;
			}
			.sprite_map_border label {
				color: white;
				position: absolute;
				font-size: tiny;
				left: 2px;
				top: 2px;
			}
			.sprite_map_content {
			}
			table.grid {
				left: 0;
				top: 0;
				border-collapse: collapse;
				background-color: pink;
			}
			table.grid, table.grid th, table.grid td {
				border: 1px solid red;
			}
			.grid_dimensions {
				text-align: right;
				padding-right: 20px;
			}
			div.view_setup {
				display: inline-block;
				background-color: lightblue;
				text-align: center;
			}
			.view_setup_description {
				font-size: tiny;
				text-align: center;
				color: black;
				font-weight: normal;
			}
			table.view_setup {
				width: 100%;
			}
			table.view_setup div {
				display: inline-block;
				min-width: 32px;
				height: 32px;
			}
			div.view_result {
				background-color: red;
			}
			div.view_chain {
				padding-right: 32px;
				background-color: grey;
			}
			td.view_delete {
				color: red;
				background-color: grey;
				vertical-align:middle;
				text-align:center;
				font-size:120px;
				padding: 20px;
			}
			div.mspf_setup {
				padding: 10px;
			}
		</style>
		<script src="js/jquery.js"></script>
		<script>
			var img = null;
			$(document).ready( function() {
				img = new Image();
				// online image source: http://www.sebissimos.com/gch/index.php?p=features
				img.src = "http://www.sebissimos.com/gch/img/vx_characters.png";
				img.onload = update_grid;
				
				// Drag'n Drop-Events für das Grid
				$(".sprite_map_border").on("dragenter", function(event) {
					event.preventDefault();
				});
				$(".sprite_map_border").on("dragover", function(event) {
					event.preventDefault();
				});
				$(".sprite_map_border").on("drop", function(event) {
					event.preventDefault();
					var dt = event.originalEvent.dataTransfer;
					if( dt.files && dt.files.length ) {
						// inspired by: http://robertnyman.com/html5/canvas/the-cure.html
						var file = dt.files[0];
						if( typeof FileReader !== "undefined" && file.type.indexOf("image") != -1 ) {
							var reader = new FileReader();
							// Note: addEventListener doesn't work in Google Chrome for this event
							reader.onload = function (evt) {
								img.src = evt.target.result;
							};
							reader.readAsDataURL(file);
						}
					} else if( dt.getData("url") ) {
						img.src = dt.getData("url");
					}
				});
				
				// Drag'n Drop-Events für die Animationstabelle
				$(".view_chain").on("dragenter", function(event) {
					event.preventDefault();
				});
				$(".view_chain").on("dragover", function(event) {
					event.preventDefault();
				});
				$(".view_chain").on("drop", function(event) {
					event.preventDefault();
					var canvas = event.originalEvent.dataTransfer.mozSourceNode;
					var clone_canvas = $(canvas).clone()[0];
					$(clone_canvas).addClass( "view_chain_element" );
					$(clone_canvas).attr( {draggable:true} );
					$(clone_canvas).on("dragstart", function(event) {
						event.originalEvent.dataTransfer.setData("text/plain",this);
					});
					var ctx = clone_canvas.getContext("2d");
					ctx.drawImage( canvas, 0, 0 );
					$(this).append( clone_canvas );
					
					update_view_result( this );
				});
				
				// Drag'n Drop-Events für das Löschfeld
				$(".view_delete").on("dragenter", function(event) {
					event.preventDefault();
				});
				$(".view_delete").on("dragover", function(event) {
					event.preventDefault();
				});
				$(".view_delete").on("drop", function(event) {
					event.preventDefault();
					var canvas = event.originalEvent.dataTransfer.mozSourceNode;
					if( $(canvas).hasClass("view_chain_element") ) {
						var chain = $(canvas).closest(".view_chain")[0];
						canvas.remove();
						update_view_result( chain );
					}
				});
				
				update_mspf( $(".mspf_range")[0] );
			});
			
			var gw = null; var gh = null;
			var mw = null; var mh= null;
			var pw = null; var ph = null;
			var drop_canvas = null;
			function update_grid() {
				$("table.grid").remove();
				var grid = $("<table>");
				gw = Number($(".grid_width_input").val());
				gh = Number($(".grid_height_input").val());
				mw = img.width; 
				mh = img.height;
				pw = Math.floor(mw/gw);
				ph = Math.floor(mh/gh);
				for( h=0; h<gh; h++ ) {
					var row = $("<tr>");
					for( w=0; w<gw; w++ ) {
						var cel = $("<td>").attr( {} );
						var canvas = $("<canvas>").attr( {width:pw,height:ph,draggable:true} );
						var ctx = canvas[0].getContext("2d");
						ctx.drawImage( img, w*pw, h*ph, pw, ph, 0, 0, pw, ph );
						canvas.on("dragstart", function(event) {
							event.originalEvent.dataTransfer.setData("text/plain",this);
						});
						cel.append( canvas );
						row.append( cel );
					}
					grid.append( row );
				}
				grid.addClass( "grid" );
				$(".sprite_map_content").append( grid );
				$(".view_setup div").each( function(i, el) {
					el.style.minWidth = pw;
					$(el).height( ph );
				});
				$(".view_chain").each( function(i, el) {
					el.style.paddingRight = pw;
				});
			}
			
			function grid_change( name, amount ) {
				var ipt = $(".grid_"+name+"_input");
				ipt.val( Number(ipt.val())+amount );
				update_grid();
			}
			
			var mspf = 100;
			function update_view_result( chain ) {
				var cel = $(chain).closest("td");
				var view_result = $( ".view_result", cel );
				view_result.empty();
				$( "canvas.view_chain_element", chain ).each( function(i, canvas) {
					var clone_canvas = $(canvas).clone()[0];
					$(clone_canvas).removeClass( "view_chain_element" );
					$(clone_canvas).addClass( "view_result_element" );
					if( i==0 ) {
						clone_canvas.style.display="";
					} else {
						clone_canvas.style.display="none";
					}
					var ctx = clone_canvas.getContext("2d");
					ctx.drawImage( canvas, 0, 0 );
					view_result.append( clone_canvas );
				});
				update_result_interval( view_result[0], 0 );
			}
			
			function update_result_interval( view_result, next_animation_step ) {
				if( $(view_result).data().interval ) {
					clearInterval( $(view_result).data().interval );
				}
				$(view_result).data( {interval: setInterval(animate_view_result, mspf, view_result)} );
				if( next_animation_step!=undefined ) {
					$(view_result).data( {next_animation_step: next_animation_step} );
				}
			}
			
			function animate_view_result( view_result ) {
				var step_count = 0;
				$( "canvas.view_result_element", view_result ).each( function(i, canvas) {
					step_count += 1;
					if( $(view_result).data().next_animation_step==i ) {
						canvas.style.display="";
					} else {
						canvas.style.display="none";
					}
				});
				$(view_result).data().next_animation_step += 1;
				if( $(view_result).data().next_animation_step==step_count ) {
					$(view_result).data().next_animation_step=0;
				}
			}
			
			function update_mspf( mspf_input ) {
				mspf = Number( mspf_input.value );
				$(".mspf_range").val( String(mspf) );
				$(".mspf_input").val( String(mspf) );
				$("div.view_result").each( function(i,view_result) {
					update_result_interval( view_result );
				});
			}
			
			function reset_view_setup() {
				$(".view_chain").each( function(i,chain) {
					$(chain).empty();
					update_view_result( chain );
				});
			}
		</script>
	</head>
	<body>
		<div class="grid_setup">
			<div class="sprite_map_border">
				<label>Ziehe eine Animationstafel von deinem Rechner oder aus dem Web in dieses Feld und scheide sie zu!</label>
				<div class="sprite_map_content">
				</div>
			</div>
			<div class="grid_dimensions">
				<div class="grid_width">
					<label>Spalten:</label>
					<button class="grid_width_minus" onclick="grid_change('width',-1)">-</button>
					<input class="grid_width_input" type="text" size="2" value="12" onchange="update_grid()" />
					<button class="grid_width_plus" onclick="grid_change('width',+1)">+</button>
				</div>
				<div class="grid_height">
					<label>Zeilen:</label>
					<button class="grid_height_minus" onclick="grid_change('height',-1)">-</button>
					<input class="grid_height_input" type="text" size="2" value="8" onchange="update_grid()" />
					<button class="grid_height_plus" onclick="grid_change('height',+1)">+</button>
				</div>
			</div>
		</div>
		
		<div class="view_setup">
			<div class="view_setup_description">Ziehe Animationsschritte aus der Tafel in diese Sequenztabelle!</div>
			<table class="view_setup">
				<tr class="view_setup_heading">
					<th></th>
					<th>stehen</th>
					<th>gehen</th>
					<th><button onclick="reset_view_setup()">löschen</button></th>
				</tr>
				<tr class="view_front">
					<td class="front_symbol">\/</td>
					<td class="front_stand"><div class="view_result front_stand_result"></div><div class="view_chain front_stand_chain"></div></td>
					<td class="front_walk"><div class="view_result front_walk_result"></div><div class="view_chain front_walk_chain"></div></td>
					<td class="view_delete" rowspan="4">X</td>
				</tr>
				<tr class="view_left">
					<td class="left_symbol">&lt;</td>
					<td class="left_stand"><div class="view_result left_stand_result"></div><div class="view_chain left_stand_chain"></div></td>
					<td class="left_walk"><div class="view_result left_walk_result"></div><div class="view_chain left_walk_chain"></div></td>
				</tr>
				<tr class="view_right">
					<td class="right_symbol">&gt;</td>
					<td class="right_stand"><div class="view_result right_stand_result"></div><div class="view_chain right_stand_chain"></div></td>
					<td class="right_walk"><div class="view_result right_walk_result"></div><div class="view_chain right_walk_chain"></div></td>
				</tr>
				<tr class="view_back">
					<td class="back_symbol">/\</td>
					<td class="back_stand"><div class="view_result back_stand_result"></div><div class="view_chain back_stand_chain"></div></td>
					<td class="back_walk"><div class="view_result back_walk_result"></div><div class="view_chain back_walk_chain"></div></td>
				</tr>
			</table>
			<div class="mspf_setup">
				<input type="range" class="mspf_range" min="1" max="300" value="100" onchange="update_mspf(this)" />
				ms/Frame: <input type="text" class="mspf_input" onchange="update_mspf(this)" />
			</div>
		</div>
	</body>
</html>
