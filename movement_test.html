<html>
	<head>
		<script>
			var running = false;
			var standing = null;
			var moving = null;
			var is_moving = false;
			var move_lock = false;
			var move_counter = 0;
			var animation_parts = 5;
			var current_x = 10;
			var current_y = 10;
			var char_width = 80;
			var char_height = 80;
			var direction = null;
			var background1 = "images/grass_chunk1.png"
			var background2 = "images/grass_chunk2.png"
			var interval = null;
			var background_tiles = {};
			
			function store_background_tile(x_id, y_id, posx, posy, is_solid, img)
			{
				if ( background_tiles[x_id] == undefined ) 
				{
					background_tiles[x_id] = {};
				}
				if ( background_tiles[x_id][y_id] == undefined )
				{
					background_tiles[x_id][y_id] = [posx, posy, is_solid, img];
				}
				else
				{
					console.log("das tile mit der x_id \""+x_id+"\" und der y_id \""+y_id+"\" existiert bereits!");
				}
			}
			
			function get_background_tile(number)
			{
				var img_obj = new Image();
				img_obj.src = "images/grass_tile"+number+".png";
				return img_obj;
			}
			
			function generate_random_background()
			{	
				var start_x = 0;
				var start_y = 0;
				var final_x = 480;
				var final_y = 400;
				var stepped_x = start_x;
				var stepped_y = start_y;
				var step = 40;
				var i = 0;
				var j = 0;
				console.log("i vor der schleife: "+i);
				for ( i = 0; i < 20; i++ )
				{
					var random_x = Math.floor((Math.random() * 4) + 1);
					var random_tile_x = get_background_tile(random_x)
					store_background_tile(i, j, stepped_x, stepped_y, false, random_tile_x);
					console.log("++++++++++++i: "+i+" ++++++++++++");
					stepped_x = stepped_x + step;
					for ( j = 0; j < 20; j++ )
					{
						var random_y = Math.floor((Math.random() * 4) + 1);
						var random_tile_y = get_background_tile(random_x)
						store_background_tile(i, j, stepped_x, stepped_y, false, random_tile_y);
						stepped_y = stepped_y + step;
						console.log("j: "+j);
					}
				}
				/*for ( j = 0; j < 20; j++ )
					{
						var random_y = Math.floor((Math.random() * 4) + 1);
						var random_tile_y = get_background_tile(random_x)
						store_background_tile(0, j, start_x, stepped_y, false, random_tile_y);
						stepped_y = stepped_y + step;
				}*/
				draw_background();
			}
			
			function list_background_tiles()
			{
				var i = 0;
				var j = 0;
				console.log(background_tiles[0][0]);
				console.log(background_tiles[0][1]);
				console.log(background_tiles[0][2]);
				console.log(background_tiles[1][0]);
				console.log(background_tiles[1][1]);
				console.log(background_tiles[1][2]);
				
				/*for ( i = 0; i < Object.keys(background_tiles).length; i++ )
				{
					console.log(i+","+j+" "+background_tiles[i,j])
					for ( j = 1; j < Object.keys(background_tiles[i]).length; j++)
					{
						console.log(i+","+j+" "+background_tiles[i,j])
					}
				}*/
			}
			
			function draw_background()
			{
				var bg_x = 10;
				var bg_y = 10;
				bg_canvas = document.getElementById("background_canvas");
				c = bg_canvas.getContext("2d");
				
				for ( var i = 0; i < 20; i++ )
				{
					tile = background_tiles[i][0];
					tx = tile[0];
					ty = tile[1];
					img = tile[3];
					c.drawImage(img, tx, ty, 40, 40);
				}
				
				for ( var j = 0; j < 20; j++ )
				{
					tile = background_tiles[0][j];
					tx = tile[0];
					ty = tile[1];
					img = tile[3];
					c.drawImage(img, tx, ty, 40, 40);
				}
				background_tiles = {};
				/*for ( var count = 0; count < 10; count++ )
				{
					if ( count != 0 )
					{
						bg_x = bg_x + 40;
					}
					var img = load_background_image()
					
					c.drawImage(img, bg_x, bg_y, 40, 40);
				}*/
				//bg_image = new Image();
				//bg_image.src = background1;
				//c.drawImage(bg_image, 10, 10, (6*80), (5*80))
			}
			
			function move_char()
			{
				//console.log("move_char");
				if ( is_moving != null )
				{
					canvas = document.getElementById("canvas");
					c = canvas.getContext("2d");
					var image = null;
					
					if ( animation_parts == 5 )
					{
						if ( move_counter >= 0 && move_counter <= 2 )
						{
							//console.log("debug: "+move_counter);
							image = get_image("images/dummy_sprite_"+direction+"1.png");
						}
						else if ( move_counter >= 3 && move_counter <= 5 )
						{
							
							//console.log("debug: "+move_counter);
							image = get_image("images/dummy_sprite_"+direction+"2.png");
						}
					}
					else
					{
						if ( move_counter >= 0 && move_counter <= 2 )
						{
							//console.log("debug: "+move_counter);
							image = get_image("images/dummy_sprite_"+direction+"1.png");
						}
						else if ( move_counter >= 3 && move_counter <= 5 )
						{
							image = get_image("images/dummy_sprite_"+direction+".png");
						}
						else if ( move_counter >= 6 && move_counter <= 8 )
						{
							image = get_image("images/dummy_sprite_"+direction+"2.png");
						}
					}
					//console.log("debug: "+move_counter);
					var old_x = current_x;
					var old_y = current_y;
					if ( direction == "down" )
					{
						current_y = current_y + 8;
					}
					else if ( direction == "up" )
					{
						current_y = current_y - 8;
					}
					else if ( direction == "left" )
					{
						current_x = current_x - 8;
					}
					else if ( direction == "right" )
					{
						current_x = current_x + 8;
					}
					if ( current_y > 395 )
					{
						current_y = 5;
					}
					else if ( current_y < 2 )
					{
						current_y = 395;
					}
					if ( current_x < 2 )
					{
						current_x = 470;
					}
					else if ( current_x > 470 )
					{
						current_x = 5;
					}
					//console.log(image.src);
					c.clearRect(old_x, old_y, char_width, char_height);
					c.drawImage(image, current_x ,current_y, char_width, char_height);
					move_counter = move_counter + 1;
					//console.log("debug: "+move_counter);
					if ( move_counter >= animation_parts )
					{
						c.clearRect(old_x, old_y, char_width, char_height);
						c.drawImage(standing, current_x ,current_y, char_width, char_height);
						clearInterval(interval);
						move_counter = 0;
						running = false;
						is_moving = false;
						move_lock = false;
					}
				}
			}
			
			function get_image(file)
			{
				img = new Image();
				img.src = file;
				return img;
			}
			
			function start_moving(dir)
			{
				//console.log("move");
				standing = new Image();
				standing.src = "images/dummy_sprite_"+dir+".png";
				if ( running == false )
				{
					running = true;
					is_moving = true;
					direction = dir;
					interval = setInterval(move_char, 60);
				}
			}
			
			function handle_key_event(evt)
			{
				switch(evt.keyCode)
				{
					case 37:
						animation_parts = 8;
						start_moving("left");
						break;
					case 39:
						animation_parts = 8;
						start_moving("right");
						break;
					case 40:
						animation_parts = 5;
						start_moving("down");
						break;
					case 38:
						animation_parts = 5;
						start_moving("up");
						break;
				}
			}
			window.addEventListener('keydown', handle_key_event, true);
		</script>
	</head>
	<body>
		<!--<canvas id="canvas" width="600" height="600"></canvas>-->
		<div style="position: relative;">
			<canvas id="background_canvas" width="480" height="400" style="position: absolute; left: 0; top: 0; z-index: 0;"></canvas>
			<canvas id="canvas" width="480" height="400" style="position: absolute; left: 0; top: 0; z-index: 1;"></canvas>
		</div>
		<button onclick="javascript:generate_random_background()" style="position: absolute; left: 0; top: 500;">generate_random_bg</button>
		<button onclick="javascript:list_background_tiles()" style="position: absolute; left: 150; top: 500;">list tiles</button>
	</body>
</html>